@using ManaCena.Models
@using System.Reflection
@model List<Product>
@{
    ViewBag.Title = "EditProduct";
}
<h2>EditProduct</h2>

<table border="1">
    <tr>
        @*<td><label>Id</label></td>*@
        <td><label>Image</label></td>
        <td><label>Name</label></td>
        <td><label>Description</label></td>
        <td><label>Wheight</label></td>
        <td><label>Unit</label></td>
        <td><label>Size</label></td>
        <td><label>Cathegory</label></td>
    </tr>
    @foreach (var p in Model)
    {
        var rnd = Guid.NewGuid();
        <tr>
            <td style="display:none;"><input value="@p.Id" id="@rnd-@nameof(Product.Id)" /></td>
            <td>
                <img src="@p.ProductImage.Image" alt="" id="@rnd-@nameof(Product.ProductImage)">
                <input type='file' class="product-image-edit" data-image-id="@rnd-@nameof(Product.ProductImage)" />
            </td>
            <td><input value="@p.Name" id="@rnd-@nameof(Product.Name)" /></td>
            <td><input value="@p.Description" id="@rnd-@nameof(Product.Description)" /></td>
            <td><input value="@p.Wheight" id="@rnd-@nameof(Product.Wheight)" /></td>
            <td><input value="@p.Unit" id="@rnd-@nameof(Product.Unit)" /></td>
            <td><input value="@p.Size" id="@rnd-@nameof(Product.Size)" /></td>
            @*<td><input value="@p.CathegoryId" id="@rnd-@nameof(Product.CathegoryId)" /></td>*@
            @*<td><input value="@p.Cathegory.Name" id="@rnd-@nameof(Product.Cathegory)-@nameof(Cathegory.Name)" /></td>*@
            <td>
                @*<select id="@rnd-@nameof(Product.CathegoryId)" onchange="switchCathegoryTypeName('@rnd-@nameof(Product.Cathegory)-@nameof(Cathegory.Name)', this)">*@
                <select id="@rnd-@nameof(Product.CathegoryId)">
                    @foreach (var ce in (List<Cathegory>)ViewBag.CathegoryEnum)
                    {
                        <option @if (ce.Id == p.CathegoryId) { <text> selected="selected" </text> } value="@ce.Id">@string.Format("{0} - ({1})", ce.Name, ce.CathegoryType.Name)</option>
                    }
                </select>
            </td>
            @*<td><input value="@p.Cathegory.CathegoryType.Name" id="@rnd-@nameof(Cathegory)-@nameof(CathegoryType)-@nameof(CathegoryType.Name)" /></td>*@
            <td>
                <button onclick="editProduct($('#@rnd-@nameof(Product.Id)').val(),
                                             $('#@rnd-@nameof(Product.Name)').val(),
                                             $('#@rnd-@nameof(Product.Description)').val(),
                                             $('#@rnd-@nameof(Product.Wheight)').val(),
                                             $('#@rnd-@nameof(Product.Unit)').val(),
                                             $('#@rnd-@nameof(Product.Size)').val(),
                                             $('#@rnd-@nameof(Product.CathegoryId)').val(),
                                             $('#@rnd-@nameof(Product.ProductImage)').attr('src')
                                            )">
                    Save Changes
                </button>
            </td>
            <td></td>
        </tr>
    }
</table>
@section scripts {
    <script type="text/javascript">
        function editProduct(id, name, description, wheight, unit, size, cathegoryId, img) {
            $.ajax({
                type: "POST",
                url: "/Product/EditItem",
                data: {
                    Id: id, Name: name, Description: description, Wheight: wheight, Unit: unit, Size: size, CathegoryId: cathegoryId, ProductImage: { Image: img }
                },
                success: function (result) {
                    // Do something interesting here.
                }
            });
        }
    </script>

    @* Image *@
    <script type="text/javascript">

        // on image change
        $(".product-image-edit").change(function () {
            readURL(this, $(this).attr("data-image-id"));
        });

        function readURL(input, id) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#' + id).attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

    </script>

    @* Cathegory display *@
    @*<script type="text/javascript">
        function switchCathegoryTypeName(domId, id) {
            
            var res = $.grep(myArray, function (e) { return e.Id == id.value; });
            alert(res[0].Name);
            $("#" + domId).val(res[0].Name);
        };        
        
        var myArray = [];
        @foreach (var ctr in (List<CathegoryType>)ViewBag.CathegoryTypeEnum)
        {
            @:myArray.push({ Id: @ctr.Id, Name: '@ctr.Name' });

        }
    </script>*@

}