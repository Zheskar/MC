@using ManaCena.Models
@using System.Reflection
@model List<ProductSale>

<h2>Edit Product Sales</h2>

<table border="1" id="table-edit-product">
    <tr>
        @*<td><label>Id</label></td>*@
        @* TODO: ADD IMAGE DISPLAY only, on Select Change*@
        <td><label>Product Image</label></td>
        <td><label>Product Name</label></td>
        <td><label>Seller Name</label></td>
        <td><label>Original Price</label></td>
        <td><label>Discount Price</label></td>
        <td><label>Start Date</label></td>
        <td><label>End Date</label></td>
    </tr>
    @foreach (var p in Model)
    {
        var rnd = Guid.NewGuid();
        <tr id="@rnd-tr">
            <td style="display:none;"><input value="@p.Id" id="@rnd-@nameof(ProductSale.Id)" /></td>
            <td style="display:none;"><input value="@p.ProductId" id="@rnd-@nameof(ProductSale.ProductId)" /></td>
            <td>
                <img src="@if (p.Product.ProductImageSmall != null) { <text>@p.Product.ProductImageSmall.Image</text> }" id="@rnd-@nameof(Product.ProductImageSmall)">
            </td>
            @*<td><input value="@p.Product.Name" id="@rnd-@nameof(ProductSale.ProductId)@nameof(Product.Name)" /></td>*@
            <td>
                <div class="ui-widget" id="@rnd-autocomplete-removable">
                    <input class="birds" data-rnd="@rnd" id="@rnd-@nameof(ProductSale.ProductId)@nameof(Product.Name)" value="@p.Product.Name">
                </div>
            </td>
            <td>
                <select id="@rnd-@nameof(ProductSale.SellerId)">
                    @foreach (var i in (List<Seller>)ViewBag.SellerEnum)
                    {
                        <option @if (i.Id == p.SellerId) { <text> selected="selected" </text>      } value="@i.Id">@i.Name</option>
                    }
                </select>
            </td>
            <td><input value="@p.OriginalPrice" id="@rnd-@nameof(ProductSale.OriginalPrice)" /></td>
            <td><input value="@p.DiscountPrice" id="@rnd-@nameof(ProductSale.DiscountPrice)" /></td>
            <td><input value="@p.StartDate" id="@rnd-@nameof(ProductSale.StartDate)" /></td>
            <td><input value="@p.EndDate" id="@rnd-@nameof(ProductSale.EndDate)" /></td>
            <td>
                <button class="btn-submit-save" data-rnd="@rnd">Save Changes</button>
                <button class="btn-clone" data-tr-id="@rnd-tr" data-rnd="@rnd">Clone</button>
                <button class="btn-submit-del" data-tr-id="@rnd-tr" data-rnd="@rnd">Delete</button>
            </td>
            <td></td>
        </tr>
    }
</table>
@section scripts {

    @* Autocmplete *@
    <style>
        .ui-autocomplete-loading {
            background: white url("../images/jqueryui/ui-anim_basic_16x16.gif") right center no-repeat;
        }
    </style>
    <script>

        function selectedNewProduct(id, value, rnd) {
            // set new ID
            $('#' + rnd + '-@nameof(ProductSale.ProductId)').val(id);

            // change Image as well (by using API)
            $.ajax({
                type: "GET",
                url: "/Product/GetImageSmall?id=" + id,
                success: function (result) {
                    $('#' + rnd + '-@nameof(Product.ProductImageSmall)').attr('src', result);
                }
                });
            }

        $(".birds").autocomplete({
            source: "GetQuickSearch",
            minLength: 2,
            select: function (event, ui) {
                selectedNewProduct(ui.item.id, ui.item.value, $(this).attr("data-rnd"));
            }            
        });

    </script>

    @* Save *@
    <script type="text/javascript">
        $(".btn-submit-save").click(function () {
            var rnd = $(this).attr("data-rnd");
            // read all variables
            var id = $('#' + rnd + '-@nameof(ProductSale.Id)').val();
            var productId = $('#' + rnd + '-@nameof(ProductSale.ProductId)').val();
            var sellerId = $('#' + rnd + '-@nameof(ProductSale.SellerId)').val();
            var originalPrice = $('#' + rnd + '-@nameof(ProductSale.OriginalPrice)').val();
            var discountPrice = $('#' + rnd + '-@nameof(ProductSale.DiscountPrice)').val();
            var startDate = $('#' + rnd + '-@nameof(ProductSale.StartDate)').val();
            var endDate = $('#' + rnd + '-@nameof(ProductSale.EndDate)').val();

            $.ajax({
                type: "POST",
                url: "/ProductSale/EditItem",
                data: {
                    Id: id, ProductId: productId, SellerId: sellerId, OriginalPrice: originalPrice, DiscountPrice: discountPrice, StartDate: startDate, EndDate: endDate
                },
                success: function (result) {
                    // Do something interesting here.
                }
            });
        });
    </script>

    @* Delete *@
    <script type="text/javascript">
        $(".btn-submit-del").click(function () {
            var rnd = $(this).attr("data-rnd");
            var id = $('#' + rnd + '-@nameof(Cathegory.Id)').val();
            $.ajax({
                type: "POST",
                url: "/ProductSale/DeleteItem",
                data: {
                    id: id
                },
                success: function (result) {
                    // TODO: Remove DOM object, do not refresh, just remove DOM
                }
            });
                });
    </script>

    @* Image *@
    <script type="text/javascript">

        // on image change
        $(".product-image-edit").change(function () {
            readURL(this, $(this).attr("data-image-id"));
        });

        function readURL(input, id) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#' + id).attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

    </script>

    @* clone - create new record for *@
    <script>
        // Clone 2 steps
        $(".btn-clone").click(function () {

            var tr = $("#" + $(this).attr("data-tr-id")).clone(true, true);
            //e.preventDefault();
            $('#table-edit-product').append(tr.clone(true, true));

            // totaly 18 elements, and we need to start renaming clone - starting from 9th element
            var rnd = $(this).attr("data-rnd");
            var totalIndex = $('[id^="' + rnd + '"]').length;
            var timePrefixNow = $.now();
            // find 18 elements
            $('[id^="' + rnd + '"]').each(function (index) {
                if (index >= totalIndex / 2) {
                    // new random id
                    $(this).attr("id", timePrefixNow + $(this).attr("id"));
                }
                //console.log(index + ": " + $(this).attr("id"));
            });

            // find amd change clone's data-rnd
            var totalIndex2 = $('[data-rnd^="' + rnd + '"]').length;
            $('[data-rnd^="' + rnd + '"]').each(function (index) {
                if (index >= totalIndex2 / 2) {
                    // new random id
                    $(this).attr("data-rnd", timePrefixNow + $(this).attr("data-rnd"));
                }
            });

            // find and change record ID
            var cloneId = timePrefixNow + rnd + '-' + '@nameof(Product.Id)';
            $('[id^="' + cloneId + '"]').each(function (index) {
                $('[id^="' + cloneId + '"]').val('');
            });

            // MEGA HACK with autocomplete, we remove DOM phisically and add it manually later
            var clonedAutocomplete= "#" + timePrefixNow + rnd + '-' + '@nameof(ProductSale.ProductId)@nameof(Product.Name)';
            $('#' + timePrefixNow + rnd + "-autocomplete-removable").empty();
            $('#' + timePrefixNow + rnd + "-autocomplete-removable").append("<input class='birds' data-rnd='" + timePrefixNow + rnd + "' id='" + timePrefixNow + rnd+ "-@nameof(ProductSale.ProductId)@nameof(Product.Name)'>");
            $(clonedAutocomplete).autocomplete({
                source: "GetQuickSearch",
                minLength: 2,
                select: function (event, ui) {
                    selectedNewProduct(ui.item.id, ui.item.value, $(this).attr("data-rnd"));
                }
            });

        });
    </script>

}
